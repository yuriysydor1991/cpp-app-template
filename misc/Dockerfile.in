FROM ubuntu:22.04

RUN apt update
RUN apt install -y libstdc++6 build-essential git cmake g++
RUN apt install -y libboost-all-dev

WORKDIR /src

RUN git clone --single-branch --progress --branch 4.11.4 https://github.com/emweb/wt.git wt
WORKDIR /src/wt
RUN cmake -B /src/wt/build -S /src/wt  -DENABLE_LIBWTDBO=OFF -DENABLE_OPENGL=OFF \
  -DENABLE_FIREBIRD=OFF -DENABLE_POSTGRES=OFF -DENABLE_SQLITE=OFF \
  -DENABLE_MYSQL=OFF -DENABLE_MSSQLSERVER=OFF -DINSTALL_DOCUMENTATION=OFF \
  -DBUILD_EXAMPLES=OFF -DENABLE_QT4=OFF -DENABLE_QT5=OFF -DENABLE_QT6=OFF \
  -DENABLE_LIBWTTEST=OFF -DENABLE_PANGO=OFF -DENABLE_HARU=OFF -DCONNECTOR_FCGI=OFF \
  -DBUILD_TESTS=OFF -DCONNECTOR_ISAPI=OFF
RUN cmake --build /src/wt/build -j$(nproc)
RUN cmake --install /src/wt/build --prefix /usr

ARG BUILDDIR=/src/${PROJECT_BINARY_NAME}-build-docker-singlerun

RUN --mount=from=project,target=/src/${PROJECT_BINARY_NAME} \ 
 cd /src/${PROJECT_BINARY_NAME} && \
 mkdir -vp $BUILDDIR && \
 cmake -S . -B $BUILDDIR -DCMAKE_BUILD_TYPE=Release &&  \
 cmake --build $BUILDDIR -j$(nproc) --target ${PROJECT_BINARY_NAME} && \
 cmake --install $BUILDDIR --prefix /usr

CMD ["${PROJECT_BINARY_NAME}"]
